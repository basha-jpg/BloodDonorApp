<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Find Blood Donors</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family:'Inter',sans-serif; background:#f7f9fc; }
    .container-card { box-shadow: 0 10px 25px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
    .nav-link { color:#fff; font-weight:500; padding:0.5rem 0.75rem; border-radius:0.375rem; font-size:0.875rem; transition:background-color .2s; display:inline-block; }
    .nav-link:hover { background:#1d4ed8; }
    .status-available { color:#16a34a; font-weight:700; }
    .status-unavailable { color:#ca8a04; font-weight:700; }

    /* Hero background: subtle overlay to keep text readable */
    .hero {
      position: relative;
      background-image: url('https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1600&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
      border-radius: 0.75rem;
      overflow: hidden;
    }
    .hero::after {
      content: "";
      position: absolute; inset: 0;
      background: linear-gradient( to bottom, rgba(0,0,0,.35), rgba(0,0,0,.45) );
    }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <nav class="bg-blue-800 rounded-lg shadow-md mb-6">
      <div class="max-w-5xl mx-auto px-4">
        <div class="flex justify-between h-16">
          <div class="flex items-center"><span class="text-xl font-bold text-white">Public Donor Search</span></div>
          <div class="flex items-center space-x-4">
            <a href="./index.html" class="nav-link" style="background:#1e3a8a;">Search</a>
            <a href="./admin.html" class="nav-link">Admin</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- HERO (simple + not over-styled) -->
    <section class="hero h-[220px] md:h-[260px] mb-6">
      <div class="relative z-10 h-full flex flex-col items-start justify-center p-6 md:p-8 text-white">
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Donate Blood, Save Lives</h1>
        <p class="mt-2 text-sm md:text-base text-gray-100/90 max-w-xl">
          A single donation can help up to three people. Join the registry or find donors near you.
        </p>
        <a href="#register" class="mt-4 inline-block bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 rounded-lg">
          Become a Donor
        </a>
      </div>
    </section>

    <div class="grid md:grid-cols-3 gap-6">
      <!-- Search Panel -->
      <div class="md:col-span-2 container-card bg-white rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-3">Search Donors</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <select id="bloodInput" class="p-2 border rounded-lg">
            <option value="">Any Blood Group</option>
            <option>O+</option><option>O-</option>
            <option>A+</option><option>A-</option>
            <option>B+</option><option>B-</option>
            <option>AB+</option><option>AB-</option>
          </select>
          <input id="nameInput" type="text" placeholder="Filter by name (optional)" class="p-2 border rounded-lg">
          <button id="searchBtn" class="p-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">Search</button>
        </div>

        <div id="searchAlert" class="mt-4 hidden p-3 rounded-lg"></div>

        <div class="mt-4 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Blood</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
            <tbody id="publicResults" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
          <div id="noResults" class="p-6 text-center text-gray-500 font-medium hidden">No donors found.</div>
        </div>
      </div>

      <!-- Public Registration -->
      <div id="register" class="container-card bg-white rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-3">Register as a Donor</h2>
        <form id="publicRegisterForm" class="space-y-3" novalidate>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name<span class="text-red-500">*</span></label>
            <input id="pubName" type="text" required minlength="2" class="w-full p-2 border rounded-lg" placeholder="Your name">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone<span class="text-red-500">*</span></label>
            <input id="pubPhone" type="tel" required pattern="^[0-9]{10}$" class="w-full p-2 border rounded-lg" placeholder="10-digit phone">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Blood Group<span class="text-red-500">*</span></label>
            <select id="pubBlood" required class="w-full p-2 border rounded-lg">
              <option value="">Select</option>
              <option>O+</option><option>O-</option>
              <option>A+</option><option>A-</option>
              <option>B+</option><option>B-</option>
              <option>AB+</option><option>AB-</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">City (optional)</label>
            <input id="pubCity" type="text" class="w-full p-2 border rounded-lg" placeholder="City">
          </div>
          <button id="pubSubmit" type="submit" class="w-full p-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold">Submit</button>
        </form>

        <div id="publicAlert" class="mt-3 hidden p-3 rounded-lg"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = "http://127.0.0.1:5000";
    const CREATE_ENDPOINTS = ["/api/donors", "/api/donors/register"];

    const searchBtn = document.getElementById('searchBtn');
    const bloodInput = document.getElementById('bloodInput');
    const nameInput  = document.getElementById('nameInput');
    const publicResults = document.getElementById('publicResults');
    const noResults = document.getElementById('noResults');
    const searchAlert = document.getElementById('searchAlert');

    function setSearchAlert(msg, ok=false) {
      searchAlert.textContent = msg;
      searchAlert.className = `mt-4 p-3 rounded-lg ${ok ? 'bg-green-100 border border-green-400 text-green-700' : 'bg-red-100 border border-red-400 text-red-700'}`;
      searchAlert.classList.remove('hidden');
      setTimeout(()=>searchAlert.classList.add('hidden'), 2500);
    }

    function rowFromDonor(d) {
      const name  = d.Name ?? d.name ?? '';
      const phone = d.Phone_Number ?? d.phone ?? '';
      const blood = d.Blood_Group ?? d.blood_group ?? '';
      const statusRaw = d.Availability_Status ?? d.status ?? 'Available';
      const isAvail = String(statusRaw).toUpperCase() === 'AVAILABLE' || statusRaw === 'Available';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700 font-semibold">${blood}</td>
        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${phone}</td>
        <td class="px-3 py-3 whitespace-nowrap text-sm ${isAvail?'status-available':'status-unavailable'}">${isAvail?'Available':'Unavailable'}</td>
      `;
      return tr;
    }

    async function searchDonors() {
      publicResults.innerHTML = '';
      noResults.classList.add('hidden');
      searchBtn.disabled = true;
      const oldText = searchBtn.textContent;
      searchBtn.textContent = 'Searching...';

      try {
        const params = new URLSearchParams();
        if (bloodInput.value) params.set('blood_group', bloodInput.value);
        if (nameInput.value.trim()) params.set('name', nameInput.value.trim());
        const url = `${API_BASE_URL}/api/donors/search${params.toString() ? ('?' + params.toString()) : ''}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`Server returned ${resp.status}`);
        const data = await resp.json();

        if (!Array.isArray(data) || data.length === 0) {
          noResults.classList.remove('hidden');
          return;
        }
        data.forEach(d => publicResults.appendChild(rowFromDonor(d)));
      } catch (e) {
        console.error(e);
        setSearchAlert(e.message || 'Search failed');
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = oldText;
      }
    }

    // click + Enter to search
    searchBtn.addEventListener('click', searchDonors);
    [bloodInput, nameInput].forEach(el => {
      el.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); searchDonors(); } });
    });

    // Public Registration
    const pubForm = document.getElementById('publicRegisterForm');
    const pubAlert = document.getElementById('publicAlert');
    function setPubAlert(msg, ok=false) {
      pubAlert.textContent = msg;
      pubAlert.className = `mt-3 p-3 rounded-lg ${ok ? 'bg-green-100 border border-green-400 text-green-700' : 'bg-red-100 border border-red-400 text-red-700'}`;
      pubAlert.classList.remove('hidden');
      setTimeout(()=>pubAlert.classList.add('hidden'), 3000);
    }

    pubForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('pubSubmit');
      const name  = document.getElementById('pubName').value.trim();
      const phone = document.getElementById('pubPhone').value.trim();
      const blood = document.getElementById('pubBlood').value.trim();
      const city  = document.getElementById('pubCity').value.trim();

      const phoneOk = /^[0-9]{10}$/.test(phone);
      if (!name || name.length < 2) { setPubAlert('Please enter a valid name (min 2 chars).'); return; }
      if (!phoneOk) { setPubAlert('Phone must be 10 digits.'); return; }
      if (!blood) { setPubAlert('Please select a blood group.'); return; }

      const payload = {
        Name: name,
        Phone_Number: phone,
        Blood_Group: blood,
        Availability_Status: 'Available',
        City: city || undefined
      };

      btn.disabled = true;
      const oldText = btn.textContent;
      btn.textContent = 'Submitting...';

      try {
        await tryCreateDonor(payload);
        setPubAlert('Thank you! You have been registered as a donor.', true);
        pubForm.reset();
        // Show updated results (if filters match)
        searchDonors();
      } catch (err) {
        console.error(err);
        setPubAlert(`Could not register: ${err.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = oldText;
      }
    });

    async function tryCreateDonor(payload) {
      let lastErr;
      for (const path of CREATE_ENDPOINTS) {
        try {
          const resp = await fetch(`${API_BASE_URL}${path}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
          return await resp.json();
        } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('No create endpoint available');
    }

    // Load initial list on page open
    window.addEventListener('DOMContentLoaded', searchDonors);
  </script>
</body>
</html>
